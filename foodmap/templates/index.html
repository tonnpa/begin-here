<!DOCTYPE html>
<html>
<head>
    <title>Quick Start - Leaflet</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style>
        #map {
            height: 100%;
            border: 2px solid darkseagreen;
        }

        html, body {
            height: 100%;
        }

        .input-group-addon {
            min-width: 15em;
            text-align: right;
        }
    </style>
</head>
<body>

<div class="container-fluid" style="height: 100%">
    <div class="row" style="height: 100%">
        <div class="col-md-8" style="height: 100%">
            <div id="map"></div>
        </div>
        <div class="col-md-4" style="height: 100%">
            <h2> Interactive Market Explorer</h2>
            <h3> Price range </h3>
            <div class="input-group">
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr1">Inexpensive $</label>
                        <input type="checkbox" name="pricerange" value="$" id="pr1">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr2">Moderate $$</label>
                        <input type="checkbox" name="pricerange" value="$$" id="pr2">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr3">Pricey $$$</label>
                        <input type="checkbox" name="pricerange" value="$$$" id="pr3">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr4">Ultra High-End $$$$</label>
                        <input type="checkbox" name="pricerange" value="$$$$" id="pr4">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr5">Not Available</label>
                        <input type="checkbox" name="pricerange" value="n/a" id="pr5">
                    </span>
                </div>
            </div>

            <h3>Rating</h3>
            <input type="range" id="rating" min="1" max="5" value="1">

            <h3>Restaurant Category/Cuisine</h3>
            <div class="span4">
                <select id="cuisines" style="width:300px" multiple="multiple"></select>
            </div>
            <br>
            <div class="span4 center-block">
                <button type="button" class="btn btn-primary center-block" style="width: 100%" onclick="filter()">
                    Filter
                </button>
            </div>
            <h2>Priorities</h2>
            <form id="user-priority">
                <div class="form-group row">
                    <label for="weight_partners" class="col-xs-5 col-form-label">Proximity of restaurants</label>
                    <div class="col-xs-7">
                        <input class="form-control" type="number" value="1" id="weight_partners">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="weight_population" class="col-xs-5 col-form-label">Population density</label>
                    <div class="col-xs-7">
                        <input class="form-control" type="number" value="2" id="weight_population">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="weight_income" class="col-xs-5 col-form-label">Population income</label>
                    <div class="col-xs-7">
                        <input class="form-control" type="number" value="3" id="weight_income">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="weight_crime" class="col-xs-5 col-form-label">Crimes in the neighborhood</label>
                    <div class="col-xs-7">
                        <input class="form-control" type="number" value="4" id="weight_crime">
                    </div>
                </div>
                <div class="span4 center-block">
                    <button type="button" class="btn btn-success center-block" style="width: 100%"
                            onclick="highlight(this)">
                        Highlight locations
                    </button>
                </div>
            </form>
            <br>
        </div>
    </div>
</div>

<script>
    var map, restaurants, allRestaurantLayer, currentLayer;

    $(document).ready(function () {
        map = L.map('map').setView([33.748995, -84.387982], 12);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
            maxZoom: 16,
            id: 'mapbox.streets'
        }).addTo(map);

        var geojsonMarkerOptions = {
            radius: 5,
            fillColor: "teal",
            color: "teal",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.1
        };

        {#        $.get('/restaurants').done(function (data) {#}
        {#            restaurants = data;#}
        {#            allRestaurantLayer = L.geoJSON(restaurants, {#}
        {#                pointToLayer: function (feature, latlng) {#}
        {#                    return L.circleMarker(latlng, geojsonMarkerOptions);#}
        {#                }#}
        {#            });#}
        {#            currentLayer = allRestaurantLayer;#}
        {#            currentLayer.addTo(map);#}
        {#            console.log(restaurants);#}
        {#        });#}

        $.get('/categories').done(function (data) {
            var $cuisines = $('#cuisines');
            $cuisines.select2();

            for (var region in data) {
                var $region = $("<optgroup label=\"" + region + "\"></optgroup>");
                $cuisines.append($region);
                data[region].forEach(function (category) {
                    $region.append("<option value=\"" + category + "\">" + category + "</option>");
                });
            }
        });
    });

    function getSelectedPriceCategories() {
        var $checked = $("input[name=pricerange]:checked");
        var $unchecked = $("input[name=pricerange]:not(:checked)");
        var visibility = {};
        $checked.each(function (_, category) {
            visibility[category.value] = true;
        });
        $unchecked.each(function (_, category) {
            visibility[category.value] = false;
        });
        return visibility;
    }

    function getPrices() {
        var prices = [];
        var $checked = $("input[name=pricerange]:checked");
        $checked.each(function (_, category) {
            prices.push(category.value);
        });
        return prices;
    }

    function getRating() {
        return $("#rating").val();
    }

    function getSelectedCuisines() {
        return $("#cuisines").val();
    }

    function filter() {
        map.removeLayer(currentLayer);
        var selectedPriceCategories = getSelectedPriceCategories();
        currentLayer = L.geoJSON(restaurants, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions);
            },
            filter: function (feature, _) {
                var matchPrice = selectedPriceCategories[feature.properties.price];
                var matchRating = feature.properties.rating >= $("#rating").val();
                return matchPrice && matchRating;
            }
        });

        currentLayer.addTo(map);
    }

    function highlight(element) {
        function get_priorities() {
            return {
                partner: $form.find("#weight_partners").val(),
                population: $form.find("#weight_population").val(),
                income: $form.find("#weight_income").val(),
                crime: $form.find("#weight_crime").val()
            };
        }

        function get_filters() {
            return {
                price: getPrices(),
                rating: getRating(),
                categories: getSelectedCuisines()
            };
        }

        var $form = $(element).closest("form");
        $.post({
            url: '/highlight',
            contentType: 'application/json',
            data: JSON.stringify({
                priority: get_priorities(),
                filter: get_filters()
            })
        });
    }


</script>

</body>
</html>