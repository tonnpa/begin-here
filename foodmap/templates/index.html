<!DOCTYPE html>
<html>
<head>
    <title>Begin Here</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style>
        #map {
            height: 88%;
            border: 2px solid darkseagreen;
        }

        html, body {
            height: 100%;
        }

        .input-group-addon {
            min-width: 15em;
            text-align: right;
        }

        .list-group-item {
            display: list-item;
        }

    </style>
</head>
<body onload="uncheck()">

<div class="container-fluid" style="height: 100%">
    <div class="row" style="height: 100%">
        <div class="col-md-7" style="height: 100%; background-color: #3a373d">
            <div class="row" style="height: 10%">
                <h1 style="color: #fafafa; text-align: center; font-size: 4em">Begin Here</h1>
            </div>
            <div id="map"></div>
        </div>
        <div class="col-md-5" style="height: 100%">
            <h2> Interactive Market Explorer</h2>
            <h3> Price range </h3>
            <div class="input-group">
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr1">Inexpensive $</label>
                        <input type="checkbox" name="pricerange" value="$" id="pr1">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr2">Moderate $$</label>
                        <input type="checkbox" name="pricerange" value="$$" id="pr2">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr3">Pricey $$$</label>
                        <input type="checkbox" name="pricerange" value="$$$" id="pr3">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr4">Ultra High-End $$$$</label>
                        <input type="checkbox" name="pricerange" value="$$$$" id="pr4">
                    </span>
                </div>
                <div class="span4">
                    <span class="input-group-addon">
                        <label for="pr5">Not Available</label>
                        <input type="checkbox" name="pricerange" value="n/a" id="pr5">
                    </span>
                </div>
            </div>

            <h3>Rating</h3>
            <input type="range" id="rating" min="1" max="5" value="1">

            <h3>Restaurant Category/Cuisine</h3>
            <div class="span4">
                <select id="cuisines" style="width:300px" multiple="multiple"></select>
            </div>
            <br>
            <div class="span4 center-block">
                <button type="button" class="btn btn-primary center-block" style="width: 100%" onclick="filter()">
                    Filter
                </button>
            </div>
            <h2>Priorities</h2>
            <div class="col-xs-6" style="text-align: center">
                <b>Not important</b>
                <ul id="priorityPool" class="list-group" style="list-style: none">
                    <li class="priority list-group-item">Proximity of restaurants</li>
                    <li class="priority list-group-item">Population density</li>
                    <li class="priority list-group-item">Population income</li>
                    <li class="priority list-group-item">Crimes in the neighborhood</li>
                </ul>
            </div>
            <div class="col-xs-6" style="text-align: center">
                <b>Order of importance</b>
                <ol id="priorityOrder" class="list-group">
                </ol>
            </div>
            <div class="col-xs-12" style="text-align: center">
                <b>How important is your first priority compared to your last priority?</b>
            </div>
            <div class="btn-group" data-toggle="buttons" style="width: 100%">
                <label class="btn btn-secondary active" style="background-color: #96c0d8; border: solid; border-width: 1px">
                    <input type="radio" name="priorities" id="option1" autocomplete="off" checked> Equally important
                </label>
                <label class="btn btn-secondary" style="background-color: #96c0d8; border: solid; border-width: 1px">
                    <input type="radio" name="priorities" id="option2" autocomplete="off"> Somewhat more important
                </label>
                <label class="btn btn-secondary" style="background-color: #96c0d8; border: solid; border-width: 1px">
                    <input type="radio" name="priorities" id="option3" autocomplete="off"> More important
                </label>
                <label class="btn btn-secondary" style="background-color: #96c0d8; border: solid; border-width: 1px">
                    <input type="radio" name="priorities" id="option4" autocomplete="off"> Significantly more important
                </label>
            </div>
            <div class="span4 center-block">
                <button type="button" class="btn btn-success center-block" style="width: 100%"
                        onclick="highlight(this)">
                    Highlight locations
                </button>
            </div>
            </form>
            <br>
        </div>
    </div>
</div>

<script>
    var map, restaurants, allRestaurantLayer, currentLayer, geojsonMarkerOptions;

    $(document).ready(function () {
        map = L.map('map').setView([33.748995, -84.387982], 12);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
            maxZoom: 16,
            id: 'mapbox.streets'
        }).addTo(map);

        geojsonMarkerOptions = {
            radius: 5,
            fillColor: "#386cb0",
            color: "#386cb0",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.1
        };

        geojsonMarkerOptionsfilt_emph = {
            radius: 5,
            fillColor: "#e41a1c",
            color: "#e41a1c",
            weight: 1,
            opacity: 0.3,
            fillOpacity: 0.3
        };

        geojsonMarkerOptionsfilt_de_emph = {
            radius: 5,
            fillColor: "grey",
            color: "grey",
            weight: 1,
            opacity: 0.5,
            fillOpacity: 0.2
        };

        $.get('/restaurants').done(function (data) {
            restaurants = data;
            allRestaurantLayer = L.geoJSON(restaurants, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            });
            currentLayer = allRestaurantLayer;
            currentLayer.addTo(map);
            console.log(restaurants);
        });

        $.get('/categories').done(function (data) {
            var $cuisines = $('#cuisines');
            $cuisines.select2();

            for (var region in data) {
                var $region = $("<optgroup label=\"" + region + "\"></optgroup>");
                $cuisines.append($region);
                data[region].forEach(function (category) {
                    $region.append("<option value=\"" + category + "\">" + category + "</option>");
                });
            }
        });
    });

    function getSelectedPriceCategories() {
        var $checked = $("input[name=pricerange]:checked");
        var $unchecked = $("input[name=pricerange]:not(:checked)");
        var visibility = {};
        var de_emph = {}
        $checked.each(function (_, category) {
            visibility[category.value] = true;
            de_emph[category.value] = false;
        });
        $unchecked.each(function (_, category) {
            visibility[category.value] = false;
            de_emph[category.value] = true;
        });
        return [visibility, de_emph];
    }

    function getPrices() {
        var prices = [];
        var $checked = $("input[name=pricerange]:checked");
        $checked.each(function (_, category) {
            prices.push(category.value);
        });
        return prices;
    }

    function getRating() {
        return $("#rating").val();
    }

    function getSelectedCuisines() {
        return $("#cuisines").val();
    }

    function filter() {
        map.removeLayer(currentLayer);
        var selectedPriceCategories = getSelectedPriceCategories()[0];
        console.log(selectedPriceCategories)
        currentLayer = L.geoJSON(restaurants, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptionsfilt_emph);
            },
            filter: function (feature, _) {
                var matchPrice = selectedPriceCategories[feature.properties.price];
                var matchRating = feature.properties.rating >= $("#rating").val();
                return matchPrice && matchRating;
            }
        });


        if (DeEmphLayer !== undefined && DeEmphLayer !== null) {
            map.removeLayer(DeEmphLayer)
        }
        var DeselectedPriceCategories = getSelectedPriceCategories()[1];
        console.log(DeselectedPriceCategories)
        var DeEmphLayer = L.geoJSON(restaurants, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptionsfilt_de_emph);
            },
            filter: function (feature, _) {
                var mismatchPrice = DeselectedPriceCategories[feature.properties.price];
                var mismatchRating = feature.properties.rating < $("#rating").val();
                return mismatchPrice || mismatchRating;
            }
        });
        DeEmphLayer.addTo(map);
        currentLayer.addTo(map);
    }

    function highlight(element) {
        function get_priorities() {
            return {
                partner: $form.find("#weight_partners").val(),
                population: $form.find("#weight_population").val(),
                income: $form.find("#weight_income").val(),
                crime: $form.find("#weight_crime").val()
            };
        }

        function get_filters() {
            return {
                price: getPrices(),
                rating: getRating(),
                categories: getSelectedCuisines()
            };
        }

        var $form = $(element).closest("form");
        $.post({
            url: '/highlight',
            contentType: 'application/json',
            data: JSON.stringify({
                rankings: get_priorities(),
                power: 0,
                filter: get_filters()
            })
        }).done(function () {
            alert("All Done! Go see the Choropleth");
        }).fail(function () {
            alert("Try again...");
        });
    }

    $(".priority").click(function () {
        var $priority = $(this);
        $priority.fadeOut("fast", function () {
            $priority.appendTo($("#priorityOrder")).fadeIn("fast");
        });
    });


</script>

</body>
</html>