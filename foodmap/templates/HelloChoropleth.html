{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
        }

        #map-canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }
    </style>

    <title>Choropleth</title>
</head>

<body>
<div id="map-canvas"></div>
<script>
    //  Import or construct the geoJSON for each evaluation grid (NOTE the order
    //  of the coordinates is is [Long, Lat] and NOT [Lat, Lo

    {#var newdata = [{{ data }}];#}


    {#console.log(newdata);#}


    {#var mypols = {"type": "FeatureCollection", "crs": {"type": "name", "properties": {"name": "EPSG:4326"}}, "features": [{"geometry": {"type": "Polygon", "coordinates": [[[-84.51139423076924, 33.59859649122807], [-84.51139423076924, 33.60140350877193], [-84.50860576923077, 33.60140350877193], [-84.50860576923077, 33.59859649122807], [-84.51139423076924, 33.59859649122807]]]}, "type": "Feature", "properties": {"income_level": 30}}, {"geometry": {"type": "Polygon", "coordinates": [[[-84.50860576923077, 33.59859649122807], [-84.50860576923077, 33.60140350877193], [-84.50581730769233, 33.60140350877193], [-84.50581730769233, 33.59859649122807], [-84.50860576923077, 33.59859649122807]]]}, "type": "Feature", "properties": {"income_level": 30}}, {"geometry": {"type": "Polygon", "coordinates": [[[-84.5058173076923, 33.59859649122807], [-84.5058173076923, 33.60140350877193], [-84.50302884615385, 33.60140350877193], [-84.50302884615385, 33.59859649122807], [-84.5058173076923, 33.59859649122807]]]}, "type": "Feature", "properties": {"income_level": 30}}, {"geometry": {"type": "Polygon", "coordinates": [[[-84.50302884615385, 33.59859649122807], [-84.50302884615385, 33.60140350877193], [-84.50024038461538, 33.60140350877193], [-84.50024038461538, 33.59859649122807], [-84.50302884615385, 33.59859649122807]]]}, "type": "Feature", "properties": {"income_level": 30}}, {"geometry": {"type": "Polygon", "coordinates": [[[-84.50024038461538, 33.59859649122807], [-84.50024038461538, 33.60140350877193], [-84.49745192307694, 33.60140350877193], [-84.49745192307694, 33.59859649122807], [-84.50024038461538, 33.59859649122807]]]}, "type": "Feature", "properties": {"income_level": 30}}]};#}
    {#var mypols = [{#}
    {#    "type": "Feature",#}
    {#    "properties": {"income_level": 10},#}
    {#    "geometry": {#}
    {#        "type": "Polygon",#}
    {#        "coordinates": [[#}
    {#            [-84.5825, 33.519999999999996],#}
    {#            [-84.5825, 33.680000000000007],#}
    {#            [-84.4375, 33.680000000000007],#}
    {#            [-84.4375, 33.519999999999996],#}
    {#            [-84.5825, 33.519999999999996]#}
    {#        ]]#}
    {#    }#}
    {#, #}
    {#        "type": "Feature",#}
    {#        "properties": {"income_level": 120},#}
    {#        "geometry": {#}
    {#            "type": "Polygon",#}
    {#            "coordinates": [[#}
    {#                [-84.4375, 33.519999999999996],#}
    {#                [-84.4375, 33.680000000000007],#}
    {#                [-84.2925, 33.680000000000007],#}
    {#                [-84.2925, 33.519999999999996],#}
    {#                [-84.4375, 33.519999999999996]#}
    {#            ]]#}
    {#        }#}
    {#    }];#}

    // 9 colors
    var colors = ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026']



    function getColor(d) {
        return d > 90 ? colors[8] :
                d > 80 ? colors[7] :
                        d > 70 ? colors[6] :
                                d > 60 ? colors[5] :
                                        d > 50 ? colors[4] :
                                                d > 40 ? colors[3] :
                                                        d > 30 ? colors[2] :
                                                                d > 19 ? colors[1] :
                                                                        colors[0];
    }

    function gridstyle(feature) {
        return {
            color: getColor(feature.properties.crime_count_local),
            weight: 0,
            opacity: 1,
            fillOpacity: 0.7
        };
    }


    $.get("/choropleth/data").done(function (mypols) {
                var geoson = L.geoJSON(mypols, {style: gridstyle});
                var baseLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                    maxZoom: 16,
                    id: 'mapbox.streets'
                });

                var map = new L.Map('map-canvas', {
                    center: new L.LatLng(33.748995, -84.387982),
                    zoom: 11,
                    layers: [baseLayer, geoson]
                });
            }
    );


</script>

</body>
</html>